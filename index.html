<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Nexus | AI Astrologer</title>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; background: #1e293b; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h1 { color: #818cf8; margin-bottom: 5px; }
        p { color: #94a3b8; margin-top: 0; }
        
        input, select, button { width: 90%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #475569; background: #0f172a; color: white; }
        button { background: #4f46e5; font-weight: bold; border: none; cursor: pointer; transition: 0.3s; }
        button:hover { background: #4338ca; }
        button:disabled { background: #64748b; cursor: not-allowed; }
        
        #output { text-align: left; margin-top: 20px; white-space: pre-wrap; line-height: 1.6; background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid #334155; display: none; }
        .error { color: #ef4444; font-weight: bold; background: rgba(239, 68, 68, 0.1); padding: 10px; border-radius: 5px; display: block; margin-top: 10px;}
        .status { color: #fbbf24; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸ”® Cosmic Nexus</h1>
    <p>Zero-Dependency (Universal Model)</p>

    <input type="password" id="apiKey" placeholder="Step 1: Paste Gemini API Key Here">
    <input type="text" id="name" placeholder="Name">
    
    <div style="display: flex; justify-content: center; gap: 5px; width: 94%; margin: 0 auto;">
        <input type="date" id="dob" style="width: 50%;">
        <input type="time" id="tob" style="width: 50%;">
    </div>
    
    <input type="text" id="city" placeholder="City (e.g. Chennai)">
    
    <select id="modelSelect">
        <option value="gemini-pro">Model: Gemini Pro (Stable)</option>
        <option value="gemini-1.5-flash">Model: Gemini 1.5 Flash (Fast)</option>
    </select>
    
    <button onclick="runApp()" id="btn">Reveal Destiny</button>
    
    <div id="status" class="status"></div>
    <div id="output"></div>
</div>

<script>
    // --- 1. INTERNAL MATH (Calculates Planets) ---
    function calculatePlanets(dateStr, timeStr) {
        const d = new Date(dateStr + "T" + timeStr);
        const day = (d - new Date("2000-01-01T12:00:00Z")) / 86400000;
        const ayanamsa = 23.85 + (day / 365.25) * 0.0139;

        const bodies = {
            'Sun': 280.466 + 0.9856474 * day,
            'Moon': 218.316 + 13.176396 * day,
            'Mars': 355.433 + 0.524033 * day,
            'Mercury': 252.251 + 4.092334 * day,
            'Jupiter': 34.351 + 0.083085 * day,
            'Venus': 181.979 + 1.602130 * day,
            'Saturn': 50.077 + 0.033455 * day,
            'Rahu': 125.045 - 0.052954 * day
        };

        const zodiac = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];
        let report = "";

        for (let planet in bodies) {
            let lon = bodies[planet];
            let M = (lon % 360) * (Math.PI / 180); 
            if(planet === 'Sun') lon += 1.915 * Math.sin(M);
            if(planet === 'Moon') lon += 6.289 * Math.sin(M);

            let sidereal = (lon - ayanamsa) % 360;
            if (sidereal < 0) sidereal += 360;

            let signIdx = Math.floor(sidereal / 30);
            let deg = (sidereal % 30).toFixed(2);
            report += `${planet}: ${zodiac[signIdx]} (${deg}Â°)\n`;
        }
        return report;
    }

    // --- 2. GEMINI API CALL ---
    async function runApp() {
        const key = document.getElementById('apiKey').value;
        const name = document.getElementById('name').value;
        const dob = document.getElementById('dob').value;
        const tob = document.getElementById('tob').value;
        const city = document.getElementById('city').value;
        const modelId = document.getElementById('modelSelect').value; // User selected model
        
        const status = document.getElementById('status');
        const output = document.getElementById('output');

        if (!key || !dob || !tob) {
            alert("Please fill in API Key, Date, and Time.");
            return;
        }

        status.innerText = "â³ Calculating Planets...";
        output.style.display = "none";
        document.getElementById('btn').disabled = true;

        try {
            // Step A: Calculate
            const planetData = calculatePlanets(dob, tob);
            
            status.innerText = "âœ¨ Consulting the Stars...";

            // Step B: Ask Gemini
            const prompt = `
            Act as an expert Vedic Astrologer. 
            User: ${name}, Born: ${dob} ${tob} in ${city}.
            Planetary Positions (Sidereal):
            ${planetData}

            Give a 500-word deep soul analysis.
            Sections:
            1. Core Self (Lagna/Moon)
            2. 8th House Intensity
            3. Marriage (7th House)
            4. Career
            5. Spiritual Path
            
            Do NOT use markdown symbols like ** or ##. Just use plain text with nice spacing.
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${key}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();

            // Error Handling
            if (data.error) throw new Error(data.error.message);
            if (!data.candidates) throw new Error("AI blocked the request. Try again.");

            // Success
            status.innerText = "";
            output.innerText = data.candidates[0].content.parts[0].text;
            output.style.display = "block";

        } catch (err) {
            status.innerHTML = `<span class="error">Error: ${err.message}</span>`;
        } finally {
            document.getElementById('btn').disabled = false;
        }
    }
</script>

</body>
</html>
