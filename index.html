<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Nexus | AI Astrologer</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://unpkg.com/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
    
    <style>
        :root {
            --bg-color: #0f172a;
            --card-color: #1e293b;
            --text-color: #e2e8f0;
            --accent-color: #818cf8;
            --button-color: #4f46e5;
            --button-hover: #4338ca;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify_content: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 1px solid #334155;
            padding-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            color: var(--accent-color);
            font-size: 2.5rem;
        }

        .header p {
            color: #94a3b8;
        }

        .card {
            background-color: var(--card-color);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #cbd5e1;
        }

        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #475569;
            background-color: #0f172a;
            color: white;
            box-sizing: border-box;
        }

        input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .row {
            display: flex;
            gap: 15px;
        }
        
        .col {
            flex: 1;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: var(--button-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        button:hover {
            background-color: var(--button-hover);
        }

        button:disabled {
            background-color: #475569;
            cursor: not-allowed;
        }

        #status {
            text-align: center;
            font-size: 0.9rem;
            margin-top: 10px;
            color: #ef4444; /* Red for errors */
        }

        #result {
            display: none;
            line-height: 1.7;
        }

        #result h2, #result h3 {
            color: var(--accent-color);
            margin-top: 25px;
        }

        #result strong {
            color: #f1f5f9;
        }

        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--accent-color);
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ðŸ”® Cosmic Nexus</h1>
        <p>AI-Powered Vedic Astrology Analysis</p>
    </div>

    <div id="status"></div>

    <div class="card">
        <div class="form-group">
            <label for="apiKey">Step 1: Enter Gemini API Key</label>
            <input type="password" id="apiKey" placeholder="Paste your AI Studio Key here...">
            <small style="color: #64748b; display: block; margin-top: 5px;">
                Get a key for free at <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--accent-color)">Google AI Studio</a>. Key is not stored.
            </small>
        </div>
    </div>

    <div class="card">
        <h3>Step 2: Birth Details</h3>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="name" placeholder="Enter your name">
        </div>
        
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="date" id="dob">
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label>Time of Birth</label>
                    <input type="time" id="tob">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label>Birth City (Latitude)</label>
                    <input type="number" id="lat" placeholder="e.g. 13.0827" step="any">
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label>Birth City (Longitude)</label>
                    <input type="number" id="lon" placeholder="e.g. 80.2707" step="any">
                </div>
            </div>
        </div>
        <small style="color: #64748b; margin-bottom: 15px; display: block;">
            Tip: Google "Coordinates of [City Name]" to get Lat/Long.
        </small>

        <button id="generateBtn" onclick="generateReport()">Reveal Destiny</button>
    </div>

    <div class="loader" id="loader">
        <div class="spinner"></div>
        <p>Aligning stars... Parsing planetary data... Consulting the Oracle...</p>
    </div>

    <div class="card" id="result">
        </div>
</div>

<script>
    // --- CHECK IF LIBRARY LOADED ---
    window.onload = function() {
        if (typeof Astronomy === 'undefined') {
            document.getElementById('status').innerText = "âš ï¸ Error: Astronomy Library failed to load. Please refresh the page.";
            document.getElementById('generateBtn').disabled = true;
        }
    };

    // --- ASTROLOGY CALCULATIONS ---
    function calculatePositions(dateStr, timeStr) {
        const dt = new Date(dateStr + 'T' + timeStr);
        
        // 1. Calculate Ayanamsa (Lahiri Approximation)
        const year = dt.getFullYear();
        const ayanamsa = 23.85 + (year - 2000) * 0.0139; 

        // 2. Planets to track
        const bodies = [
            'Sun', 'Moon', 'Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn', 'Uranus', 'Neptune'
        ];
        
        let positions = "";
        
        bodies.forEach(body => {
            // Get Tropical Position
            const result = Astronomy.Ecliptic(body, dt);
            let tropicalLon = result.elon; 
            
            // Convert to Sidereal (Vedic)
            let siderealLon = tropicalLon - ayanamsa;
            if (siderealLon < 0) siderealLon += 360;
            
            // Determine Sign
            const signs = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", 
                           "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];
            const signIndex = Math.floor(siderealLon / 30);
            const degree = (siderealLon % 30).toFixed(2);
            
            positions += `- ${body}: ${signs[signIndex]} (${degree}Â°)\n`;
        });

        // Add Nodes (Rahu/Ketu) - Approx
        const node = Astronomy.Ecliptic('MoonNode', dt);
        let rahuLon = (node.elon - ayanamsa);
        if (rahuLon < 0) rahuLon += 360;
        let ketuLon = (rahuLon + 180) % 360;
        
        const signs = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", 
                       "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];
                       
        positions += `- Rahu: ${signs[Math.floor(rahuLon/30)]} (${(rahuLon%30).toFixed(2)}Â°)\n`;
        positions += `- Ketu: ${signs[Math.floor(ketuLon/30)]} (${(ketuLon%30).toFixed(2)}Â°)\n`;

        return { positions, ayanamsa };
    }

    // --- GEMINI API CALL ---
    async function generateReport() {
        const apiKey = document.getElementById('apiKey').value;
        const name = document.getElementById('name').value;
        const dob = document.getElementById('dob').value;
        const tob = document.getElementById('tob').value;
        const lat = document.getElementById('lat').value;
        const lon = document.getElementById('lon').value;

        if (!apiKey) { alert("Please enter your API Key."); return; }
        if (!name || !dob || !tob) { alert("Please fill in all birth details."); return; }

        document.getElementById('generateBtn').disabled = true;
        document.getElementById('loader').style.display = 'block';
        document.getElementById('result').style.display = 'none';

        try {
            // 1. Calculate Data
            const astroData = calculatePositions(dob, tob);
            
            // 2. Construct Prompt
            const prompt = `
            Act as an expert Vedic Astrologer. Analyze this chart for:
            Name: ${name}
            DOB: ${dob} Time: ${tob}
            Coordinates: ${lat}, ${lon}
            
            Calculated Sidereal Positions (Lahiri Ayanamsa approx ${astroData.ayanamsa.toFixed(2)}):
            ${astroData.positions}
            
            Task: Provide a "Deep Soul Analysis" (approx 600 words).
            Structure the response exactly like this:
            
            ## 1. The Core Self (Lagna & Moon)
            [Analyze their personality, aura, and emotional nature]

            ## 2. The 8th House Intensity
            [Analyze hidden powers, transformation, and occult potential]

            ## 3. Love & Marriage (7th House)
            [Detailed prediction of the spouse: appearance, profession, and nature of marriage]

            ## 4. Career & Destiny
            [Professional path and wealth sources]

            ## 5. Spiritual Path & Karma
            [Is this a significant lifetime? What is their karmic lesson?]
            
            Tone: Mystical, Authoritative, Empathetic. Use bold formatting for key predictions.
            `;

            // 3. Call Gemini API
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const rawText = data.candidates[0].content.parts[0].text;
            document.getElementById('result').innerHTML = marked.parse(rawText);
            document.getElementById('result').style.display = 'block';

        } catch (error) {
            alert("Error: " + error.message);
        } finally {
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('loader').style.display = 'none';
        }
    }
</script>

</body>
</html>
